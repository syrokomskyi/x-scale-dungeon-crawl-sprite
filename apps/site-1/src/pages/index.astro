---
import Filter from "../components/Filter.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import ImageCard from "../components/ImageCard.astro";
import Layout from "../layouts/Layout.astro";

const baseUrl = import.meta.env.BASE_URL;

const images = await import("../../public/data/images.json");
const imageList = images.default;
---

<Layout title="Tool for Creating Fan Gallery for Any Roguelike Game">
  <Header />
  <main class="container mx-auto px-4 py-8">
    <div
      id="gallery"
      class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
    >
      {
        imageList.map((image) => (
          <ImageCard
            path={image.path}
            name={image.name}
            note={image.note}
            icon={image.icon}
          />
        ))
      }
    </div>
  </main>
  <Footer />
</Layout>

<div
  id="fullscreen-overlay"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center p-4"
>
  <div
    class="bg-gray-800 rounded-lg shadow-2xl max-w-2xl max-h-full overflow-hidden border-4 border-gray-600 relative"
  >
    <img
      id="fullscreen-img"
      src=""
      alt=""
      class="w-full object-contain rounded-t-lg"
    />
    <div
      class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent"
    >
      <h3 id="fullscreen-name" class="text-xl text-white">
        <span id="creature-name"></span>
      </h3>
    </div>
  </div>
</div>

<script is:inline define:vars={{ baseUrl }}>
  let currentFilter = [];

  window.addEventListener("filterChange", (e) => {
    currentFilter = e.detail.selected;
    filterGallery();
  });

  function filterGallery() {
    const gallery = document.getElementById("gallery");
    const cards = gallery.querySelectorAll(".image-card");
    cards.forEach((card) => {
      const path = card.dataset.path;
      const show =
        currentFilter.length === 0 ||
        path.startsWith("redraw-v1/" + currentFilter.join("/") + "/");
      card.style.display = show ? "" : "none";
    });
  }

  // Shuffle the gallery cards on load
  function shuffleGallery() {
    const gallery = document.getElementById("gallery");
    const cards = Array.from(gallery.children);
    for (let i = cards.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [cards[i], cards[j]] = [cards[j], cards[i]];
    }
    cards.forEach((card) => gallery.appendChild(card));
  }

  // Shuffle on DOM content loaded
  document.addEventListener("DOMContentLoaded", () => {
    shuffleGallery();

    // Add click listeners to images
    const images = document.querySelectorAll(".image-card img");
    images.forEach((img) => {
      img.addEventListener("click", () => {
        const card = img.closest(".image-card");
        const path = card.dataset.path;
        const name = img.alt;
        const note = card.dataset.note;
        const icon = card.dataset.icon;
        openFullscreen(path, name, note, icon);
      });
    });
  });

  function openFullscreen(path, name, note, icon) {
    const overlay = document.getElementById("fullscreen-overlay");
    const img = document.getElementById("fullscreen-img");
    const creatureNameEl = document.getElementById("creature-name");
    img.src = `${baseUrl}/${path}`.replace("//", "/");
    img.alt = name;
    creatureNameEl.textContent = name;
    overlay.classList.remove("hidden");
    overlay.classList.add("flex");
  }

  function closeFullscreen() {
    const overlay = document.getElementById("fullscreen-overlay");
    overlay.classList.remove("flex");
    overlay.classList.add("hidden");
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeFullscreen();
    }
  });

  document
    .getElementById("fullscreen-overlay")
    .addEventListener("click", (e) => {
      if (e.target === e.currentTarget) {
        closeFullscreen();
      }
    });
</script>
