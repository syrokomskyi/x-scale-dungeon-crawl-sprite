---
const filters = await import("../../public/data/filters.json");
---

<div id="filter" class="mb-4 flex flex-wrap gap-2 bg-transparent z-40 justify-center"></div>

<script define:vars={{ filters }}>
  const filterEl = document.getElementById("filter");
  let selected = [];

  function renderFilter() {
    const currentPath = selected;
    const available = getAvailable(currentPath);
    filterEl.innerHTML = "";

    // selected as [selected]
    currentPath.forEach((sel, index) => {
      const btn = document.createElement("button");
      btn.textContent = `[${sel}]`;
      btn.className =
        "bg-amber-700 text-white px-3 py-2 rounded border-2 border-amber-500 shadow-lg hover:bg-amber-600";
      btn.onclick = () => {
        selected = selected.slice(0, index);
        renderFilter();
        dispatchFilterChange();
        scrollToTop();
      };
      filterEl.appendChild(btn);
    });

    // next level as unselected
    available.forEach((cat) => {
      const btn = document.createElement("button");
      btn.textContent = cat;
      btn.className =
        "bg-stone-600 text-stone-200 px-3 py-2 rounded border-2 border-stone-500 shadow-lg hover:bg-stone-500";
      btn.onclick = () => {
        selected.push(cat);
        renderFilter();
        dispatchFilterChange();
        scrollToTop();
      };
      filterEl.appendChild(btn);
    });
  }

  function getAvailable(path) {
    let current = filters.default;
    for (const p of path) {
      if (typeof current[p] === "object" && current[p] !== null) {
        current = current[p];
      } else {
        return [];
      }
    }
    return Object.keys(current);
  }

  function dispatchFilterChange() {
    const event = new CustomEvent("filterChange", { detail: { selected } });
    window.dispatchEvent(event);
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  renderFilter();
</script>
